name: Claude Bot PR Review

on:
  workflow_call:
    inputs:
      comment_id:
        description: "ID of the triggering comment"
        type: number
        required: true
      pr_number:
        description: "Pull request number"
        type: number
        required: true
      comment_user:
        description: "Username who triggered the bot"
        type: string
        required: true
      comment_body:
        description: "Full text of the triggering comment"
        type: string
        required: true
      claude_model:
        description: "Claude model to use for review"
        type: string
        default: "claude-sonnet-4-6"
      max_diff_chars:
        description: "Maximum characters of diff to send to Claude"
        type: number
        default: 80000
    secrets:
      ANTHROPIC_API_KEY:
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          pr_json=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}")
          echo "title=$(echo "$pr_json" | jq -r '.title')" >> "$GITHUB_OUTPUT"
          echo "sha=$(echo "$pr_json" | jq -r '.head.sha')" >> "$GITHUB_OUTPUT"
          {
            echo "body<<BODYEOF"
            echo "$pr_json" | jq -r '.body // ""'
            echo "BODYEOF"
          } >> "$GITHUB_OUTPUT"

      - name: React to comment
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          COMMENT_ID: ${{ inputs.comment_id }}
        run: |
          gh api "repos/${REPO}/issues/comments/${COMMENT_ID}/reactions" \
            -f content='eyes'

      - name: Fetch PR diff (changed files only)
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ inputs.pr_number }}
          MAX_DIFF_CHARS: ${{ inputs.max_diff_chars }}
        run: |
          set -euo pipefail

          diff=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}" \
            -H "Accept: application/vnd.github.v3.diff")

          changed_files=$(gh api "repos/${REPO}/pulls/${PR_NUMBER}/files" \
            --paginate --jq '.[].filename')

          truncated=""
          if [ "${#diff}" -gt "${MAX_DIFF_CHARS}" ]; then
            diff="${diff:0:${MAX_DIFF_CHARS}}"
            truncated="\n\n[NOTE: Diff was truncated at ${MAX_DIFF_CHARS} characters. Some changes were not reviewed.]"
          fi

          {
            echo "diff<<DIFFEOF"
            echo "${diff}${truncated}"
            echo "DIFFEOF"
          } >> "$GITHUB_OUTPUT"

          {
            echo "changed_files<<FILESEOF"
            echo "${changed_files}"
            echo "FILESEOF"
          } >> "$GITHUB_OUTPUT"

      - name: Parse user instructions
        id: instructions
        env:
          COMMENT_BODY: ${{ inputs.comment_body }}
        run: |
          # Strip the @claude-bot mention and extract the user's instruction
          user_instruction=$(echo "${COMMENT_BODY}" | sed 's/@claude-bot//gI' | xargs)

          {
            echo "instruction<<INSTREOF"
            echo "${user_instruction}"
            echo "INSTREOF"
          } >> "$GITHUB_OUTPUT"

      - name: Review with Claude
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: ${{ inputs.claude_model }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_BODY: ${{ steps.pr.outputs.body }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          CHANGED_FILES: ${{ steps.diff.outputs.changed_files }}
          USER_INSTRUCTION: ${{ steps.instructions.outputs.instruction }}
        run: |
          set -euo pipefail

          system_prompt="You are a senior software engineer performing a thorough code review. Review ONLY the changes in this pull request diff â€” do not comment on unchanged code.

          IMPORTANT â€” Line number references:
          - The diff uses unified diff format. Each hunk header shows \`@@ -old_start,old_count +new_start,new_count @@\`
          - When referencing issues, use the format: \`file/path.ext:LINE_NUMBER\` where LINE_NUMBER is the line number in the NEW file (the + side of the diff)
          - This allows reviewers to jump directly to the relevant code

          Default review categories (apply all unless the user requests a specific focus):
          1. **Bugs & Correctness** â€” Logic errors, off-by-one mistakes, null/undefined risks, race conditions, incorrect return values
          2. **Security** â€” Injection vulnerabilities, secret exposure, buffer overflows, auth/authz issues, unsafe input handling
          3. **Performance** â€” Unnecessary allocations, redundant operations, algorithmic complexity, memory leaks, resource cleanup
          4. **Code Quality & Best Practices** â€” Naming conventions, readability, dead code, unused variables, proper error handling, RAII compliance, const-correctness
          5. **Linting & Style** â€” Consistent formatting, proper includes, warning-free compilation flags, modern language idioms
          6. **Suggestions** â€” Better approaches, missing edge cases, test coverage gaps

          Prioritize issues by severity. If code is clean, say so briefly â€” don't invent problems.

          End your review with one of:
          - **Verdict: APPROVE** â€” No significant issues found
          - **Verdict: REQUEST CHANGES** â€” Issues that should be fixed before merging
          - **Verdict: NEEDS DISCUSSION** â€” Design or architectural concerns to discuss"

          # Build user message with optional focus instruction
          user_message="## Pull Request: ${PR_TITLE}

          ### Description
          ${PR_BODY}

          ### Changed Files
          ${CHANGED_FILES}

          ### Diff
          \`\`\`diff
          ${PR_DIFF}
          \`\`\`"

          if [ -n "${USER_INSTRUCTION}" ]; then
            user_message="${user_message}

          ### Reviewer Instructions
          The reviewer specifically asked: **${USER_INSTRUCTION}**
          Focus your review on this request. If the request is about a specific aspect (e.g. 'check for linting', 'review security', 'check memory leaks'), prioritize that category but still flag any critical issues in other categories."
          fi

          payload=$(jq -n \
            --arg model "${CLAUDE_MODEL}" \
            --arg system "${system_prompt}" \
            --arg user "${user_message}" \
            '{
              model: $model,
              max_tokens: 4096,
              system: $system,
              messages: [
                {
                  role: "user",
                  content: $user
                }
              ]
            }')

          response=$(curl -s -w "\n%{http_code}" \
            "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${ANTHROPIC_API_KEY}" \
            -H "anthropic-version: 2023-06-01" \
            -d "${payload}")

          http_code=$(echo "${response}" | tail -1)
          body=$(echo "${response}" | sed '$d')

          if [ "${http_code}" -ne 200 ]; then
            echo "::error::Claude API returned HTTP ${http_code}"
            echo "${body}" | jq . 2>/dev/null || echo "${body}"
            exit 1
          fi

          review=$(echo "${body}" | jq -r '.content[0].text')

          if [ -z "${review}" ] || [ "${review}" = "null" ]; then
            echo "::error::Failed to extract review text from Claude response"
            echo "${body}" | jq .
            exit 1
          fi

          {
            echo "review<<REVIEWEOF"
            echo "${review}"
            echo "REVIEWEOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ inputs.pr_number }}
          REVIEW: ${{ steps.review.outputs.review }}
          PR_SHA: ${{ steps.pr.outputs.sha }}
          COMMENT_USER: ${{ inputs.comment_user }}
          CLAUDE_MODEL: ${{ inputs.claude_model }}
          USER_INSTRUCTION: ${{ steps.instructions.outputs.instruction }}
        run: |
          if [ -n "${USER_INSTRUCTION}" ]; then
            focus_line="**Focus:** ${USER_INSTRUCTION}"
          else
            focus_line="**Focus:** Full review"
          fi

          comment=$(cat <<EOF
          ## ðŸ¤– Claude Code Review

          ${focus_line}

          ${REVIEW}

          ---
          *Review by [Claude](https://claude.ai) (${CLAUDE_MODEL}) â€” commit \`${PR_SHA}\` â€” requested by @${COMMENT_USER}*
          EOF
          )

          gh pr comment "${PR_NUMBER}" --repo "${REPO}" --body "${comment}"
          echo "âœ… Review posted successfully"
